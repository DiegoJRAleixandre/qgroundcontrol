name: Build QGC MacOS 

#We only perform this on the "main" branch
on: 
    push:
        branches:
        - actions-build-macOS-test4

defaults:
  run:
    shell: bash

env:
  JOBS: 3
  SPEC: macx-clang
  CONFIG: installer
  ACTIONS_BUILD_DIR: ${{ github.workspace }}/../qgroundcontrol

jobs:
  #Name of the jod in this case "build"
  build-job:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]
        exclude:
          - os: ubuntu-latest
          - os: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Before install
        run:  |
              git fetch --unshallow && git fetch --all --tags
              export JOBS=$((`sysctl -n hw.ncpu`+1))

      - name: install QT via action
        uses: jurplel/install-qt-action@v2
        with: 
          version: '5.12.6'
          host: 'mac'
          target: 'desktop'
          dir: '${{ runner.temp }}'
          modules: 'qtcharts'
          setup-python: 'false'

      - name: Install Gstreamer
        run:  |
              wget --quiet https://qgroundcontrol.s3-us-west-2.amazonaws.com/dependencies/gstreamer-osx-1.18.1.tar.bz2
              sudo tar -zxf gstreamer-osx-1.18.1.tar.bz2 -C /Library/Frameworks
        
      - name: mkdir directory shadow_build
        run:  mkdir ${{ runner.temp }}/shadow_build_dir

      - name: run qmake and build
        working-directory: ${{ runner.temp }}/shadow_build_dir
        run:  |
              echo "Current working directory -- $PWD"
              qmake -r ${ACTIONS_BUILD_DIR}/qgroundcontrol.pro CONFIG+=${CONFIG}
              make -j$JOBS

      - name: list folders inside
        working-directory: ${{ runner.temp }}/shadow_build_dir
        run:  ls

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
      - name: Upload Release Asset
        id: upload-release-asset 
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps 
          asset_path: ${SHADOW_BUILD_DIR}/qgc-app/
          asset_name: macOSTest